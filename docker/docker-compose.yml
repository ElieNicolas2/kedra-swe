services:
  mongo:
    image: mongo:7
    container_name: kedra-mongo
    restart: unless-stopped
    ports:
      - "27017:27017"
    environment:
      MONGO_INITDB_DATABASE: kedra
      MONGO_INITDB_ROOT_USERNAME: root
      MONGO_INITDB_ROOT_PASSWORD: rootpass
    volumes:
      - mongo_data:/data/db
    healthcheck:
      test: ["CMD-SHELL", "mongosh --username root --password rootpass --eval 'db.adminCommand({ ping: 1 })' --quiet"]
      interval: 10s
      timeout: 5s
      retries: 15

  crawler:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    depends_on:
      mongo:
        condition: service_healthy
    environment:
      MONGO_URI: mongodb://root:rootpass@mongo:27017
      MONGO_DB: kedra
      MONGO_COLLECTION: decisions
      DATE_FROM: "1/10/2025"
      DATE_TO: "15/10/2025"
      BODY_ARG: "15376"
      OUTPUT_PATH: "data/landing/sample_docker.jsonl"
      LOG_FILE: "logs/crawl.log"
    volumes:
      - ./data:/app/data
      - ./logs:/app/logs
      - ./crawler_cache:/app/.scrapy
    command: >
      bash -lc "scrapy crawl search
      -a date_from=$${DATE_FROM}
      -a date_to=$${DATE_TO}
      $${BODY_ARG:+-a body=$${BODY_ARG}}
      $${Q_ARG:+-a q='$${Q_ARG}'}
      -O $${OUTPUT_PATH}
      -s LOG_FILE=$${LOG_FILE}"

volumes:
  mongo_data:
